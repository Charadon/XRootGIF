#/bin/sh

enable_randr() {
    sed -i 's/__DEFINES/-D HAVE_XRANDR/;s/__LIBRARIES/-lXrandr/' Makefile
}

enable_xinerama() {
    sed -i 's/__DEFINES/-D HAVE_XINERAMA/;s/__LIBRARIES/-lXinerama/' Makefile
}

autodetect() {
    if [ -e "/usr/lib/libXrandr.so" ] ||
           [ -e "/lib/libXrandr.so" ]; then

        echo "Detected libXrandr!"
        enable_randr

    elif [ -e "/usr/lib/libXinerama.so" ] ||
             [ -e "/lib/libXinerama.so" ]; then

        echo "Detected libXinerama!"
        enable_xinerama

    else

        echo "Neither libXrandr or libXinerama found, XRootGIF won't be able to scale images per monitor..."
        sed -i 's/__DEFINES//;s/__LIBRARIES//' Makefile

    fi
}

check_pkgname() {
    [[ $pkgname =~ ^[A-Za-z0-9_-]+$ ]] || {
        echo "Invalid pkgname"
        exit 1
    }
}

# Substitute functions #########################################################
substitute_prefix() {
    sed -i 's@__PREFIX@'"$prefix"'@' "$1"
}
substitute_cflags() {
    sed -i 's@__CFLAGS@'"$cflags"'@' "$1"
}
substitute_lnflags() {
    sed -i 's@__LNFLAGS@'"$lnflags"'@' "$1"
}
substitute_pkgname() {
    sed -i 's@__PKGNAME@'"$pkgname"'@' "$1"
}


help() {
    cat <<EOF
Configuration available:
    --force-xinerama
    --force-randr
    --prefix=
    --cflags=
    --lnflags=
    --pkgname=
EOF
    exit 0
}

# Setup files ##################################################################
cp -vf Makefile.in Makefile
cp -vf utils/zsh-completion.in utils/zsh-completion
cp -vf utils/bash-completion.in utils/bash-completion

pkgname=xrootgif

while getopts "h-:" opt; do
    case $opt in
        -)
            OPTNAME=${OPTARG%=*}
            OPTVAL=${OPTARG#*=}
            case "$OPTNAME" in
                help)
                    help
                    ;;
                force-xinerama)
                    do_force_xinerama="true"
                    ;;
                force-randr)
                    do_force_randr="true"
                    ;;
                prefix)
                    prefix="$OPTVAL"
                    ;;
                cflags)
                    cflags="$OPTVAL"
                    ;;
                lnflags)
                    lnflags="$OPTVAL"
                    ;;
                pkgname)
                    pkgname="$OPTVAL"
                    ;;
            esac
            ;;
        h)
            help
            ;;
    esac
done

check_pkgname

if [ -n "$do_force_xinerama" ] && [ -n "$do_force_randr" ]; then
    echo "Cannot force randr and xinerama at the same time!"
    exit 1
elif [ -n "$do_force_xinerama" ]; then
     enable_xinerama
elif [ -n "$do_force_randr" ]; then
     enable_randr
else
    autodetect
fi

substitute_cflags Makefile
substitute_lnflags Makefile
substitute_prefix Makefile
substitute_pkgname Makefile

substitute_pkgname  utils/zsh-completion
substitute_pkgname  utils/bash-completion
